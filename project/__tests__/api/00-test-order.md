# API 測試順序和依賴關係

本文檔說明了 API 測試的執行順序和依賴關係，以確保測試反映真實的業務流程。

## 測試執行順序

1. **基礎資料測試**
   - `warehouses.test.ts` - 倉庫資料
   - `suppliers.test.ts` - 供應商資料
   - `categories.test.ts` - 產品類別資料（待實現）

2. **中層資料測試**
   - `products.test.ts` - 產品資料（依賴於產品類別）

3. **業務操作資料測試**
   - `purchases.test.ts` - 採購單（依賴於供應商、倉庫和產品）
   - `transfers.test.ts` - 調撥單（依賴於倉庫和產品）
   - `inventory-audits.test.ts` - 庫存稽核（依賴於倉庫和產品）

## 重要業務邏輯

1. **成本價確定流程**
   - 產品初始建檔時可設定預估成本價
   - 實際成本價在採購單簽收確認後才會定案
   - 採購單簽收確認後，會更新相關產品的成本價
   - 採購單確認必須由 ADMIN 角色用戶執行，確保成本價的管控
   - 成本價變更會影響後續的庫存價值計算和毛利率分析

2. **權限控制**
   - 只有 ADMIN 角色的用戶可以查看和編輯成本價
   - MANAGER 和 STAFF 角色的用戶無法查看成本價相關資訊
   - API 返回的產品資料需要根據用戶角色過濾成本價資訊
   - 採購單確認功能僅限 ADMIN 角色使用，確保成本價的安全管理

3. **數據依賴關係**
   - 產品依賴於產品類別
   - 採購單依賴於供應商、產品
   - 調撥單依賴於倉庫、產品
   - 庫存稽核依賴於倉庫、產品
   - 成本價更新依賴於採購單確認流程

## 測試策略

每個測試文件都應該包含以下測試案例：

1. **未認證用戶測試** - 確保未登入用戶無法訪問 API
2. **權限測試** - 測試不同角色用戶的訪問權限
3. **數據完整性測試** - 確保返回的數據符合預期
4. **錯誤處理測試** - 測試 API 對錯誤情況的處理

## 採購單確認流程測試

採購單確認流程是一個關鍵的業務流程，需要特別注意以下測試點：

1. **角色權限測試**
   - 確保只有 ADMIN 角色可以確認採購單
   - 確保 MANAGER 和 STAFF 角色無法確認採購單

2. **成本價更新測試**
   - 確保採購單確認後，相關產品的成本價會被更新
   - 確保成本價更新使用採購單中的單價

3. **事務完整性測試**
   - 確保採購單確認和成本價更新在同一個事務中完成，保證數據一致性
   - 確保任何一步失敗都會導致整個事務回滾

4. **數據可見性測試**
   - 確保成本價只對 ADMIN 角色可見
   - 確保 API 返回的數據根據用戶角色正確過濾成本價信息
